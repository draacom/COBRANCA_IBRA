{"ast":null,"code":"import axios from 'axios';\n\n// Determina a baseURL dinamicamente para evitar depender do proxy do CRA\nfunction resolveBaseURL() {\n  const envURL = process.env.REACT_APP_API_URL;\n  // Se a env for absoluta, respeitar\n  if (envURL && /^https?:\\/\\//.test(envURL)) return envURL;\n  const hostname = typeof window !== 'undefined' ? window.location.hostname : 'localhost';\n  const port = typeof window !== 'undefined' ? window.location.port : '';\n\n  // Ambientes de desenvolvimento acessíveis por navegador (3000/3003/3004): apontar para porta 3001 no mesmo host\n  if (port === '3000' || port === '3003' || port === '3004') {\n    if (hostname === 'localhost' || hostname === '127.0.0.1') {\n      return 'http://localhost:3001/api';\n    }\n    return `${window.location.protocol}//${hostname}:3001/api`;\n  }\n\n  // Caso contrário, usar relativo (produção com Nginx proxyando /api)\n  return '/api';\n}\nconst resolvedBaseURL = resolveBaseURL();\n// Opcional: ajuda debug no navegador\ntry {\n  console.debug('API baseURL:', resolvedBaseURL);\n} catch (_) {}\nconst api = axios.create({\n  baseURL: resolvedBaseURL\n});\n\n// Interceptor para adicionar token em todas as requisições\napi.interceptors.request.use(config => {\n  const token = localStorage.getItem('token');\n  if (token) {\n    config.headers.Authorization = `Bearer ${token}`;\n  }\n  return config;\n}, error => {\n  return Promise.reject(error);\n});\n\n// Interceptor para renovar token quando expirar\napi.interceptors.response.use(response => response, async error => {\n  var _error$response, _originalRequest$url, _originalRequest$url2, _error$response2;\n  const originalRequest = error.config;\n  console.log('API Interceptor: Erro capturado:', {\n    status: (_error$response = error.response) === null || _error$response === void 0 ? void 0 : _error$response.status,\n    url: originalRequest === null || originalRequest === void 0 ? void 0 : originalRequest.url,\n    isAuthEndpoint: originalRequest === null || originalRequest === void 0 ? void 0 : (_originalRequest$url = originalRequest.url) === null || _originalRequest$url === void 0 ? void 0 : _originalRequest$url.startsWith('/auth/'),\n    retry: originalRequest._retry\n  });\n\n  // Se o erro for 401 (Unauthorized), não tentar refresh em endpoints de auth (login/register)\n  const isAuthEndpoint = originalRequest === null || originalRequest === void 0 ? void 0 : (_originalRequest$url2 = originalRequest.url) === null || _originalRequest$url2 === void 0 ? void 0 : _originalRequest$url2.startsWith('/auth/');\n  if (((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.status) === 401 && !originalRequest._retry && originalRequest.url !== '/auth/refresh' && !isAuthEndpoint) {\n    originalRequest._retry = true;\n    console.log('API Interceptor: Tentando renovar token...');\n    try {\n      // Tentar renovar o token\n      const token = localStorage.getItem('token');\n      const response = await axios.post(`${api.defaults.baseURL}/auth/refresh`, {\n        token\n      });\n      const {\n        token: newToken\n      } = response.data.data;\n      localStorage.setItem('token', newToken);\n      api.defaults.headers.common['Authorization'] = `Bearer ${newToken}`;\n      originalRequest.headers['Authorization'] = `Bearer ${newToken}`;\n      console.log('API Interceptor: Token renovado com sucesso');\n      return api(originalRequest);\n    } catch (refreshError) {\n      console.log('API Interceptor: Falha ao renovar token, fazendo logout');\n      // Se falhar, fazer logout\n      localStorage.removeItem('token');\n      localStorage.removeItem('user');\n      window.location.href = '/login';\n      return Promise.reject(refreshError);\n    }\n  }\n  return Promise.reject(error);\n});\nexport default api;","map":{"version":3,"names":["axios","resolveBaseURL","envURL","process","env","REACT_APP_API_URL","test","hostname","window","location","port","protocol","resolvedBaseURL","console","debug","_","api","create","baseURL","interceptors","request","use","config","token","localStorage","getItem","headers","Authorization","error","Promise","reject","response","_error$response","_originalRequest$url","_originalRequest$url2","_error$response2","originalRequest","log","status","url","isAuthEndpoint","startsWith","retry","_retry","post","defaults","newToken","data","setItem","common","refreshError","removeItem","href"],"sources":["D:/OneDrive/Attachments/Área de Trabalho/projetos/COBRANCA_IBRA/frontend/src/services/api.js"],"sourcesContent":["import axios from 'axios';\n\n// Determina a baseURL dinamicamente para evitar depender do proxy do CRA\nfunction resolveBaseURL() {\n  const envURL = process.env.REACT_APP_API_URL;\n  // Se a env for absoluta, respeitar\n  if (envURL && /^https?:\\/\\//.test(envURL)) return envURL;\n\n  const hostname = typeof window !== 'undefined' ? window.location.hostname : 'localhost';\n  const port = typeof window !== 'undefined' ? window.location.port : '';\n\n  // Ambientes de desenvolvimento acessíveis por navegador (3000/3003/3004): apontar para porta 3001 no mesmo host\n  if (port === '3000' || port === '3003' || port === '3004') {\n    if (hostname === 'localhost' || hostname === '127.0.0.1') {\n      return 'http://localhost:3001/api';\n    }\n    return `${window.location.protocol}//${hostname}:3001/api`;\n  }\n\n  // Caso contrário, usar relativo (produção com Nginx proxyando /api)\n  return '/api';\n}\n\nconst resolvedBaseURL = resolveBaseURL();\n// Opcional: ajuda debug no navegador\ntry { console.debug('API baseURL:', resolvedBaseURL); } catch (_) {}\n\nconst api = axios.create({\n  baseURL: resolvedBaseURL,\n});\n\n// Interceptor para adicionar token em todas as requisições\napi.interceptors.request.use(\n  (config) => {\n    const token = localStorage.getItem('token');\n    if (token) {\n      config.headers.Authorization = `Bearer ${token}`;\n    }\n    return config;\n  },\n  (error) => {\n    return Promise.reject(error);\n  }\n);\n\n// Interceptor para renovar token quando expirar\napi.interceptors.response.use(\n  (response) => response,\n  async (error) => {\n    const originalRequest = error.config;\n\n    console.log('API Interceptor: Erro capturado:', {\n      status: error.response?.status,\n      url: originalRequest?.url,\n      isAuthEndpoint: originalRequest?.url?.startsWith('/auth/'),\n      retry: originalRequest._retry\n    });\n\n    // Se o erro for 401 (Unauthorized), não tentar refresh em endpoints de auth (login/register)\n    const isAuthEndpoint = originalRequest?.url?.startsWith('/auth/');\n    if (error.response?.status === 401 && !originalRequest._retry && \n        originalRequest.url !== '/auth/refresh' && !isAuthEndpoint) {\n      originalRequest._retry = true;\n      \n      console.log('API Interceptor: Tentando renovar token...');\n      \n      try {\n        // Tentar renovar o token\n        const token = localStorage.getItem('token');\n        const response = await axios.post(\n          `${api.defaults.baseURL}/auth/refresh`,\n          { token }\n        );\n        \n        const { token: newToken } = response.data.data;\n        localStorage.setItem('token', newToken);\n        api.defaults.headers.common['Authorization'] = `Bearer ${newToken}`;\n        originalRequest.headers['Authorization'] = `Bearer ${newToken}`;\n        \n        console.log('API Interceptor: Token renovado com sucesso');\n        return api(originalRequest);\n      } catch (refreshError) {\n        console.log('API Interceptor: Falha ao renovar token, fazendo logout');\n        // Se falhar, fazer logout\n        localStorage.removeItem('token');\n        localStorage.removeItem('user');\n        window.location.href = '/login';\n        return Promise.reject(refreshError);\n      }\n    }\n    \n    return Promise.reject(error);\n  }\n);\n\nexport default api;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}