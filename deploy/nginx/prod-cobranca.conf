upstream cobranca_frontend {
    server 154.38.191.226:3003; # frontend dev server (HMR)
}

upstream cobranca_backend {
    server 154.38.191.226:3001; # backend Node (ecosystem.config.js usa 3001)
}

server {
    listen 80;
    server_name cobranca.ibrainformatica.com.br;
    # redireciona para https
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cobranca.ibrainformatica.com.br;

    # Certificados (ajuste caminhos após emitir com certbot)
    ssl_certificate     /etc/letsencrypt/live/cobranca.ibrainformatica.com.br/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cobranca.ibrainformatica.com.br/privkey.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # HSTS (opcional – ative após validar HTTPS)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Frontend (em produção pode apontar para build estático em Nginx)
    location /sockjs-node/ {
        proxy_pass http://cobranca_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    location /static/             { proxy_pass http://cobranca_frontend; }
    location /asset-manifest.json { proxy_pass http://cobranca_frontend; }
    location /favicon.ico         { proxy_pass http://cobranca_frontend; }
    location /manifest.json       { proxy_pass http://cobranca_frontend; }

    # Backend
    location /api/    { proxy_pass http://cobranca_backend; }
    location /public/ { proxy_pass http://cobranca_backend; }
    # Alias: permitir acesso via /invoice/<id> à rota pública
    location ^~ /invoice/ {
        rewrite ^/invoice/(.*)$ /public/invoice/$1 break;
        proxy_pass http://cobranca_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    location /imgs/   { proxy_pass http://cobranca_backend; }

    location / {
        proxy_pass http://cobranca_frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}
